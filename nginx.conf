# Redirect mappings from old prod site to new stage site
# Path-only format: works across all environments
map $uri $redirect_uri {
    /deploy-applications/deploy-hello-world-to-glueops /deploy-applications/deploy-first-app;
    /deploy-applications/deploy-python-app-to-glueops /deploy-applications/deploy-first-app;
    /deploy-applications/deploy-docusarus-website-to-glueops /deploy-applications/deploy-first-app;
    /deploy-applications/adding-configurations-and-secrets-to-the-hello-world-app-glueops-platform /deploy-applications/manage-environment-secrets;
}

server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        # Apply explicit redirects for old prod paths
        if ($redirect_uri != "") {
            return 301 $scheme://$host$redirect_uri;
        }

        # SPA fallback: serve index.html for client-side routing
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    gzip_min_length 256;
}
