# Redirect mappings from old prod site to new stage site
# Path-only format: works across all environments
map $uri $redirect_uri {
    /deploy-applications/deploy-hello-world-to-glueops /deploy-applications/deploy-first-app;
    /deploy-applications/deploy-python-app-to-glueops /deploy-applications/deploy-first-app;
    /deploy-applications/deploy-docusarus-website-to-glueops /deploy-applications/deploy-first-app;
    /deploy-applications/adding-configurations-and-secrets-to-the-hello-world-app-glueops-platform /deploy-applications/manage-environment-secrets;
}

# Disable robots/SEO crawling for non-prod environments
map $host $robots_disallow {
    default "";
    docs-nonprod.glueops.dev "noindex, nofollow";
    docs-stage.glueops.dev "noindex, nofollow";
    localhost "noindex, nofollow";
    ~^.*\.devtunnels\.ms$ "noindex, nofollow";
}

# robots.txt content based on environment
map $host $robots_content {
    default "User-agent: *\nDisallow: /\n";
    docs.glueops.dev "User-agent: *\nAllow: /\n";
    docs-nonprod.glueops.dev "User-agent: *\nDisallow: /\n";
    docs-stage.glueops.dev "User-agent: *\nDisallow: /\n";
    localhost "User-agent: *\nDisallow: /\n";
    ~^.*\.devtunnels\.ms$ "User-agent: *\nDisallow: /\n";
}

server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Add noindex/nofollow header for non-prod environments
    add_header X-Robots-Tag $robots_disallow;

    location = /robots.txt {
        default_type text/plain;
        return 200 $robots_content;
    }

    location / {
        # Apply explicit redirects for old prod paths
        if ($redirect_uri != "") {
            return 301 $scheme://$host$redirect_uri;
        }

        # SPA fallback: serve index.html for client-side routing
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    gzip_min_length 256;
}
